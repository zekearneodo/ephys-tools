%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Script for creating big raster of all the trials for a cell for neil,
%%% using the trial structure from export_data

function [raster] = raster_neil(mouse,sess,rec,unitNumber)
    %unit is a unit of the type of neil units
    %get the data of the unit, get all the trials the unit is in (from neil
    %trials, and make a raster centered on the first inhale after onset of
    %odor
    % 
    %unitNumber is which unit of that rec you want to get the raster.
    
    fn = file_names(mouse,sess,rec);
    load(fn.exp_unit);
    load(fn.exp_trial);
    
    %the trials in exp are already refined (output of neil_trial_structure)
    %get that trial structure and go trial by trial adding rows to the big
    %raster
    t1 = -200;
    t2 = 500;
    
    nt=numel(trial);
    odors   = {trial.odorName};
    concs   = [trial.odorConc];
    trialId = {trial.iD};
    tVec = (t_pre:t_post);
    spikes = zeros(length(tVec),nt);
    sp = unit(unitNumber).times;
    
    for it = 1:nt
        %get all the spikes for this unit within the window tVec
        ii = find(trial(it).sniffZeroTimes(1,:)>trial(it).odorTimes(1)*1.009,1);
        if isempty(ii) || ii<1
            continue
        end
        t0 = tr(it).sniffZeroTimes(1,ii);
        spikeTimes = sp((sp>t0+t1)&(sp<t0+t2))-t0;
        spikes(spikeTimes,nt) = 1;    
    end
end